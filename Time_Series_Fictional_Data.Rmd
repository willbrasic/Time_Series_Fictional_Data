---
title: "Exploratory Time Series Analysis with Fictional Data"
author: "William Brasic"
date: "3/4/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Clear Environment and Console
```{r eval = FALSE}
rm(list=ls())
cat("\014")
```


### Set Working Directory
```{r eval = FALSE}
setwd("C:/Users/wbras/OneDrive/Desktop/GitHub/Time_Series_Fictional_Data_R")
```

<p>&nbsp;</p>

## Data Preliminaries

<p>&nbsp;</p>

### Load Necessary Packages
```{r message = F, warning = F}
if (!require(tidyverse)) install.packages('tidyverse')
if (!require(tsibble)) install.packages('tsibble')
if (!require(gridExtra)) install.packages('gridExtra')
if (!require(feasts)) install.packages('feasts')
if (!require(pacman)) install.packages('pacman')

pacman::p_load(tidyverse, tsibble)
```

<p>&nbsp;</p>

### Load Dataset 
```{r message = F}
df <- read_csv('SIM_2.csv')[-3:-4]

```

<p>&nbsp;</p>

### Convert Data to Time Series Dataframe
```{r}
df <- tsibble(Time = 1:100, y1 = df$Y1, index = 'Time')
```

<p>&nbsp;</p>

### Plot y1 over Time
```{r}
plot.y1.time <- df %>%
  ggplot() + 
  geom_line(aes(x = Time, y = y1), color = '#003399', size = 1) + 
  ggtitle('y1 Against Time') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Time') + 
  ylab('y1')
plot.y1.time
# Looks fairly stationary; possibly not though. Check ACF and PACF for further evidence.
```

<p>&nbsp;</p>

```{r}
mean(df$y1[25:50]) 
# mean is -2.17 for 25% of data. 
```

```{r}
(mean(df$y1[1:24]) + mean(df$y1[51:100]))/2 
# mean is very close to 0 for other part of data
```

<p>&nbsp;</p>

### Differencing y1
```{r}
df <- df %>%
  mutate(y1.d1 = difference(y1,1))

plot.y1.d1.time <- df %>%
  ggplot() + 
  geom_line(aes(x = Time, y = y1.d1), color = '#003399', size = 1) + 
  ggtitle('Differenced y1 Against Time') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Time') + 
  ylab('y1 Differenced')
```

<p>&nbsp;</p>

### Putting y1 and y1.d1 Into One Picture
```{r warning=F}
gridExtra::grid.arrange(plot.y1.time, plot.y1.d1.time, ncol=1) 
# Looks like differencing made the series look like white noise
```

<p>&nbsp;</p>

## Plotting Empirical ACFs and PACFs

<p>&nbsp;</p>

### Empirical ACF for y1
```{r}
plot.y1.acf <- df %>%
  feasts::ACF(y1) %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black',
           alpha = 0.7) +
  ggtitle('ACF for y1') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('ACF')
```

<p>&nbsp;</p>

### Empirical PACF for y1
```{r}
plot.y1.pacf <- df %>%
  feasts::ACF(y1, type = 'partial') %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black',
           alpha = 0.7) +
  ggtitle('PACF for y1') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('PACF')
```

<p>&nbsp;</p>

### Empirical ACF for Differenced y1
```{r}
plot.y1.d1.acf <- df %>%
  feasts::ACF(y1.d1) %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black',
           alpha = 0.7) +
  ggtitle('ACF for Differenced y1') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('ACF')
```

<p>&nbsp;</p>

### Empirical PACF for Differenced y1
```{r}
plot.y1.d1.pacf <- df %>%
  feasts::ACF(y1.d1, type = 'partial') %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black',
           alpha = 0.7) +
  ggtitle('PACF for Differenced y1') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('PACF')
```

<p>&nbsp;</p>

### Putting ACF and PACF Plot for y1 into One Picture 
```{r fig.show='hide'}
plot.y1.acf.pacf <- gridExtra::grid.arrange(plot.y1.acf, plot.y1.pacf, nrow=1)
```

<p>&nbsp;</p>

### Putting ACF and PACF Plot for Differenced y1 into One Picture
```{r fig.show='hide'}
plot.y1.d1.acf.pacf <- gridExtra::grid.arrange(plot.y1.d1.acf, plot.y1.d1.pacf, nrow=1)
```

<p>&nbsp;</p>

### All Pictures Together
```{r warning=F, fig.height=10}
gridExtra::grid.arrange(plot.y1.time, plot.y1.acf.pacf,
                        plot.y1.d1.time, plot.y1.d1.acf.pacf, nrow=4)
# Looks like differencing the data did make it white noise.
# Based on the non-differenced ACF we definitely have an AR process. Looking then at the PACF we should have an AR(1)
```

<p>&nbsp;</p>


## Model Estimation

### Load Necessary Packages
```{r message = F, warning = F}
if (!require(fable)) install.packages('fable')
if (!require(fabletools)) install.packages('fabletools')
if (!require(tseries)) install.packages('tseries')
if (!require(car)) install.packages('car')


pacman::p_load(fable, fabletools)
```

<p>&nbsp;</p>


### AR(1) w/ Intercept 
```{r}
y1.AR1 <- df %>%
  model(ARIMA(y1 ~ 1+ pdq(1,0,0) + PDQ(0,0,0)))
report(y1.AR1)
coef(y1.AR1)
```

<p>&nbsp;</p>

### AR(2) w/ Intercept
```{r}
y1.AR2 <- df %>%
  model(ARIMA(y1 ~ 1+ pdq(2,0,0) + PDQ(0,0,0)))
report(y1.AR2)
coef(y1.AR2)
```

<p>&nbsp;</p>

### ARMA(1,1) w/ Intercept
```{r}
y1.ARMA11 <- df %>%
  model(ARIMA(y1 ~ 1+ pdq(1,0,1) + PDQ(0,0,0)))
report(y1.ARMA11)
coef(y1.ARMA11)
```

<p>&nbsp;</p>

### ARMA (2,1) w/ Intercept
```{r}
y1.ARMA21 <- df %>%
  model(ARIMA(y1 ~ 1+ pdq(2,0,1) + PDQ(0,0,0)))
report(y1.ARMA21)
coef(y1.ARMA21)
```

<p>&nbsp;</p>


### AR(2) no intercept 
```{r}
y1.AR2.interceptless <- df %>%
  model(ARIMA(y1 ~ pdq(2,0,0) + PDQ(0,0,0)))
report(y1.AR2.interceptless)
coef(y1.AR2.interceptless)
```

<p>&nbsp;</p>

### ARMA(1,1) no intercept 
```{r}
y1.ARMA11.interceptless <- df %>%
  model(ARIMA(y1 ~ pdq(1,0,1) + PDQ(0,0,0)))
report(y1.ARMA11.interceptless)
coef(y1.ARMA11.interceptless)
```


#### Based on information criteria methods the AR(1) model has best fit 

<p>&nbsp;</p>

## Visual Residual Inspection


### First Few Residuals
```{r}
head(residuals(y1.AR1), n = 10)
```

<p>&nbsp;</p>

### Histogram of Residuals
```{r}
plot.y1.AR1.hist.residuals <- residuals(y1.AR1) %>%
  ggplot(aes(x = .resid)) + 
  geom_histogram(binwidth=0.2, color="black", fill="#FF9999") + 
  ggtitle('Histogram of Residuals') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('AR(1) Residuals') + 
  ylab('Count')
```

<p>&nbsp;</p>

### Residuals Over Time
```{r}
plot.y1.AR1.residuals.time <- residuals(y1.AR1) %>%
  ggplot() + 
  geom_line(aes(x = Time, y = .resid), color = '#003399', size = 1) + 
  ggtitle('AR(1) Residuals Against Time') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Time') + 
  ylab('AR(1) Residuals')
```

<p>&nbsp;</p>

### Empirical ACF for AR(1) Residuals
```{r}
plot.y1.AR1.residuals.acf <- residuals(y1.AR1) %>%
  feasts::ACF(.resid) %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black') +
  ggtitle('ACF for AR(1) Residuals') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('ACF')
```

<p>&nbsp;</p>

### Empirical PACF for AR(1) Residuals
```{r}
plot.y1.AR1.residuals.pacf <- residuals(y1.AR1) %>%
  feasts::ACF(.resid, type = 'partial') %>%
  autoplot() +
  geom_bar(stat = 'identity', 
           fill = "#FF9999",
           color = 'black') +
  ggtitle('PACF for AR(1) Residuals') + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab('Lag') + 
  ylab('PACF')
```

<p>&nbsp;</p>

### EACF and EPACF Together
```{r fig.show='hide'}
plot.y1.AR1.residuals.acf.pacf <- gridExtra::grid.arrange(plot.y1.AR1.residuals.acf, 
                                                          plot.y1.AR1.residuals.pacf, 
                                                          nrow=1)
```

<p>&nbsp;</p>

### Various Residual Plots Together
```{r fig.height=10}
gridExtra::grid.arrange(plot.y1.AR1.residuals.time, 
                        plot.y1.AR1.hist.residuals,
                        plot.y1.AR1.residuals.acf.pacf, 
                        nrow=3) 
# Residuals appear to be white noise
```

<p>&nbsp;</p>

## Testing for Residual White Noise, i.e., Normality and Zero Autocorrelation

<p>&nbsp;</p>

### Ljung-Box Test for Autocorrelation for Lag = 8 
```{r}
residuals(y1.AR1) %>% 
  features(.resid, feasts::ljung_box, lag = 8, dof = 2)
# High p-value. Hence, fail to reject null of zero residual autocorrelation
```

<p>&nbsp;</p>

### Ljung-Box Test for Autocorrelation for Lag = 16
```{r}
residuals(y1.AR1) %>% 
  features(.resid, feasts::ljung_box, lag = 16, dof = 2)
# High p-value. Hence, fail to reject null of zero residual autocorrelation
```

<p>&nbsp;</p>

### Ljung-Box Test for Autocorrelation for Lag = 24 
```{r}
residuals(y1.AR1) %>% 
  features(.resid, feasts::ljung_box, lag = 24, dof = 2)
# High p-value. Hence, fail to reject null of zero residual autocorrelation
```

<p>&nbsp;</p>

### Durbin-Watson Test for Autocorrelation. Applicable Since AR(1) 
```{r}
residuals(y1.AR1) %>% 
  features(.resid, car::durbinWatsonTest,  alternative = c("two.sided")) 
# Test statistic close to 2 as expected. Hence, fail to reject null of zero residual autocorrelation
```

<p>&nbsp;</p>

### Jarque-Bera Test for Normality 
```{r}
tseries::jarque.bera.test(residuals(y1.AR1)$.resid)
# High p-value. Hence, fail to reject null of normality
```







